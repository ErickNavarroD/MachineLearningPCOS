---
title: "MEDI504B - Final project report"
author: "Erick Navarro & Timo Totlppa"
date: "2023-01-18"
output: pdf_document
---

# 1 Introduction and background
Polycystic ovary syndrome (PCOS) is the most common endocrine disorder of women
of reproductive age affecting between 5-18% of women.[1,2] This complex 
multisystem disease is characterized by irregular menstrual periods, androgen 
excess and enlarged polycystic ovaries, and is associated with infertility, 
mental health disorders, obesity, dyslipidaemia, type 2 diabetes mellitus and a 
higher risk of cardiovascular disease.[2-4] The disease has a substantial 
negative effect on individuals' quality of life and health status, and thus 
early diagnosis and effective specialist treatment is crucial.[1]
  Diagnosis is confirmed by the presence of two of three criteria: irregular
cycles, polycystic ovary morphology (identified with a transvaginal ultrasound),
and hyperandrogenism (biochemical based on blood tests or clinical features such
as acne, hair loss and excess hair growth).[2] However, the genetic and ethnic


[1] Joham AE, Norman RJ, Stener-Victorin E, et al. Polycystic ovary syndrome. Lancet Diabetes Endocrinol. 2022;10(9):668-680. doi:10.1016/S2213-8587(22)00163-2
[2] Teede HJ, Misso ML, Costello MF, et al. Recommendations from the international evidence-based guideline for the assessment and management of polycystic ovary syndrome. Fertil Steril. 2018;110(3):364-379. doi:10.1016/j.fertnstert.2018.05.004
[3] Sendur SN, Yildiz BO. Influence of ethnicity on different aspects of polycystic ovary syndrome: a systematic review. Reprod Biomed Online. 2021;42(4):799-818. doi:10.1016/j.rbmo.2020.12.006
[4] Morgante G, Darino I, Span√≤ A, et al. PCOS Physiopathology and Vitamin D Deficiency: Biological Insights and Perspectives for Treatment. J Clin Med. 2022;11(15):4509. doi:10.3390/jcm11154509

# 2 Objectives
This project aims to develop and validate a model to predict the need for 
patients to undergo further testing based on their clinical history in order to 
diagnose polycystic ovary syndrome (PCOS). without external validation

# 3 Methods 

```{r}
#Drop variables not used for modeling
data <- subset(data, select = -c(blood_group, 
                                 pulse_rate, 
                                 rr, 
                                 hb, 
                                 marriage_status, 
                                 pregnant, 
                                 i_betahcg, 
                                 ii_betahcg, 
                                 tsh)
               )

# Create dataset 1 using only variables obtained through through patient history
data_set1 <- subset(data, select = c(pcos,
                                     age,
                                     cycle,
                                     cycle_length,
                                     no_of_abortions,
                                     weight_gain,
                                     hair_growth,
                                     skin_darkening,
                                     hair_loss,
                                     pimples,
                                     fast_food,
                                     reg_exercise)
               )

# Create dataset 2 using variables obtained through patient history and clinical examination
data_set2 <- subset(data, select = c(pcos,
                                     age,
                                     cycle,
                                     cycle_length,
                                     no_of_abortions,
                                     weight_gain,
                                     hair_growth,
                                     skin_darkening,
                                     hair_loss,
                                     pimples,
                                     fast_food,
                                     reg_exercise,
                                     weight,
                                     height,
                                     bmi,
                                     hip,
                                     waist,
                                     waist_hip_ratio,
                                     bp_systolic,
                                     bp_diastolic)
                    )

# Create dataset 3 using variables obtained through patient history, clinical examination and blood tests
data_set3 <- subset(data, select = c(pcos,
                                     age,
                                     cycle,
                                     cycle_length,
                                     no_of_abortions,
                                     weight_gain,
                                     hair_growth,
                                     skin_darkening,
                                     hair_loss,
                                     pimples,
                                     fast_food,
                                     reg_exercise,
                                     weight,
                                     height,
                                     bmi,
                                     hip,
                                     waist,
                                     waist_hip_ratio,
                                     bp_systolic,
                                     bp_diastolic,
                                     fsh,
                                     lh,
                                     fsh_lh_ratio,
                                     amh,
                                     prl,
                                     vitd3,
                                     prg,
                                     rbs)
                    )

# Create dataset 4 using variables obtained through patient history, clinical examination, blood tests and ultrasound
data_set4 <- subset(data, select = -c(id))
```

# Results
## Exploratory Data Analysis
This is the first step of the course project of developing a model to diagnose PCOS. On this section, I will explore the dataset, clean it, and understand its variables. 

### Load and clean the data

First, I will load the packages that I will use throughout the analysis and the data. 

```{r load packages and dataset, message=FALSE}
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(DataExplorer)
library(knitr)

data = read_excel(here("PCOS_data_without_infertility.xlsx"), sheet = "Full_new") %>% 
  clean_names()
```

Then, I will take a look at the data, remove redundant variables, and make sure that each column is formatted in the right data type. 

```{r}
glimpse(data)
```

By taking a quick look at the data, I can observe that sl_no and patient_file have apparently the same information. Also, the last column (x45) seems to be empty. I will remove those variables and change the format of the variables when needed. 

```{r Check the variables}
#looks like sl_no and patient_file_no are the same column? 
all(identical(data$sl_no, data$patient_file_no))
#Also, column x45 looks like empty. I checked the excel file and it is an empty column

#Clean and change the format of the dataset
data = data %>% 
  select(-c(sl_no, x45)) %>% 
  mutate(patient_file_no = as.character(patient_file_no),
         pcos_y_n = as.factor(pcos_y_n),
         ii_beta_hcg_m_iu_m_l = case_when(ii_beta_hcg_m_iu_m_l == "1.99."~ "1.99", #I found
                                          #this typo when exploring the missing data and
                                          # checking the excel file of said individual
                                          TRUE ~ ii_beta_hcg_m_iu_m_l),
         ii_beta_hcg_m_iu_m_l = as.numeric(ii_beta_hcg_m_iu_m_l),
         amh_ng_m_l = as.numeric(amh_ng_m_l),
         #Recode the blood group to the right variable
         blood_group = case_when(blood_group == 11 ~ "A+",
                                 blood_group == 12 ~ "A-",
                                 blood_group == 13 ~ "B+",
                                 blood_group == 14 ~ "B-",
                                 blood_group == 15 ~ "O+",
                                 blood_group == 16 ~ "O-",
                                 blood_group == 17 ~ "AB+",
                                 blood_group == 18 ~ "AB-",),
         pregnant_y_n = as.factor(pregnant_y_n),
         weight_gain_y_n = as.factor(weight_gain_y_n),
         hair_growth_y_n = as.factor(hair_growth_y_n),
         skin_darkening_y_n = as.factor(skin_darkening_y_n),
         hair_loss_y_n = as.factor(hair_loss_y_n),
         pimples_y_n = as.factor(pimples_y_n),
         fast_food_y_n = as.factor(fast_food_y_n),
         reg_exercise_y_n = as.factor(reg_exercise_y_n))

glimpse(data)
```

Now the data is in the right format, so we can proceed to plot it and explore it.

### Explore missing values

As a first step of the exploration, I will check the missingness of each variable in my dataset. 
```{r plot missing data, fig.dim = c(8, 10)}
plot_missing(data)
```

We can see that there is a missing value in the variables fast_food_y_n, marriage_status_yrs and amh_ng_m_l. I will explore if it's missing in the same person

```{r}
data %>% 
  filter(is.na(fast_food_y_n) | 
           is.na(marraige_status_yrs) |
           is.na(amh_ng_m_l)) %>% 
  select(c(patient_file_no, fast_food_y_n, marraige_status_yrs, amh_ng_m_l)) %>% 
  knitr::kable()
```

We can observe that the individuals with missing observations are different. I will flag individuals 157, 306 and 456 in case this creates a problem later in the analysis, but since each of them have only one missing variable, I don't think it's needed to remove them. 

### Explore variation of continuous variables

Next, I will explore the variability of the continuous variables in the dataset. 
```{r}
plot_histogram(data)
```

We can observe that the variables prg_ng_m_l and vit_d3_ng_m_l have almost zero variation. I will explore them more in detail. 
```{r}
data %>% 
  ggplot(aes(x = "prg_ng_m_l", y = prg_ng_m_l)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  ggplot(aes(x = "vit_d3_ng_m_l", y = vit_d3_ng_m_l)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

We have 5 and 2 samples with a value different than 0 in prg_ng_m_l and vit_d3_ng_m_l, respectively. Then, I decided to remove them before I conduct the analysis, since they won't likely be informative.
```{r}
data = data %>% 
  select(-c(vit_d3_ng_m_l,prg_ng_m_l))
```

### Explore variation of categorical variables
Next, I will explore the variability of the categorical variables.

```{r}
plot_bar(data %>% 
           select(-patient_file_no))
```
We can observe that none of the variables show an important lack of variation. Then, I won't remove any of them. 

### Explore covariation

Finally, I will explore the covariation of all of the variables in the dataset to see if there's any strong correlation between some of my variables that need to be accounted for. 

```{r,  fig.dim = c(8, 10)}
plot_correlation(data %>% 
                   select(-patient_file_no), 
                 type = 'all',
                 cor_args = list("use" = "complete.obs"))
```

Since I don't see any strong correlation between distinct variables. I can see some degree of correlation between discrete variables, such as skin darkening, hair growth, weight gain and PCOS. I will keep this in mind in the future of the analysis, but I won't remove any variable at this point based on this criteria. 

### Conclusion
This EDA was very helpful to familiarize myself with the data, clean it, and identify any pattern that could potentially need to be addressed in the future of my analysis. I was able to flag individuals with missing observations, remove variables with a lack of variability, and observe the correlation between my variables. 


## Logistic regression model

# Supplementary information
## Data dictionary 
