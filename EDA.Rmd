---
title: "MEDI 504B - Exploratory Data Analysis"
author: "Erick Navarro"
date: "2023-01-11"
output: 
  pdf_document:
    toc: true
    toc_depth: 4
---

## 1 Introduction 

The goal of this report is to conduct an exploratory data analysis (EDA) of [a publicly available dataset](https://www.kaggle.com/datasets/prasoonkottarathil/polycystic-ovary-syndrome-pcos?resource=download) of polycystic ovary syndrom (PCOS),  a hormonal disorder common among women of reproductive age. 

This is the first step of the course project of developing a model to diagnose PCOS. On this deliverable, I will explore the dataset, clean it, and understand its variables. 

## 2 Exploratory Data Analysis

### 2.1 Load libraries and data files
The packages that need to be installed for this exploratory data analysis include 'janitor', 'tidyverse', 'DataExplorer', 'skimr', 'here', 'knitr' and 'readxl.' The names of the columns are cleaned using the janitor package.

```{r load packages and dataset, message=FALSE}
# Load required libraries
library(tidyverse)
library(here)
library(readxl)
library(janitor)
library(DataExplorer)
library(knitr)
library(skimr)

# Load the data file to a data frame
data = read_excel(here("PCOS_data_without_infertility.xlsx"), sheet = "Full_new") %>% 
  clean_names()
```

### 2.2 Data preprocessing
An overview of the data is shown using 'glimpse' and 'skim'.

```{r}
glimpse(data)
skim(data)
```

The overview of the data reveals that sl_no and patient_file seem to have the same information. The majority of observations in the last column (x45) are missing (539 out of 541). The variables 'sl_no' and 'x45' have therefore been removed. 

The names of the variables include the units of measure, making the variable names complex. These have been simplified to facilitate analysis. Finally, variables were mutated to the correct data types and factor levels have been specified.

```{r Check the variables}
# Confirm that sl_no and patient_file_no are the same column
all(identical(data$sl_no, data$patient_file_no))

# Remove variables 'sl_no' and 'x45'
data <- subset(data, select = -c(sl_no,x45))

# Rename variables to simplify them
data <- data %>% 
  rename(
    id = patient_file_no,
    pcos = pcos_y_n,
    age = age_yrs,
    weight = weight_kg,
    height = height_cm,
    pulse_rate = pulse_rate_bpm,
    rr = rr_breaths_min,
    hb = hb_g_dl,
    cycle = cycle_r_i,
    cycle_length = cycle_length_days,
    marriage_status = marraige_status_yrs,
    pregnant = pregnant_y_n,
    no_of_abortions = no_of_aborptions,
    i_betahcg = i_beta_hcg_m_iu_m_l,
    ii_betahcg = ii_beta_hcg_m_iu_m_l,
    fsh = fsh_m_iu_m_l,
    lh =lh_m_iu_m_l,
    fsh_lh_ratio = fsh_lh,
    hip = hip_inch,
    waist = waist_inch,
    tsh = tsh_m_iu_l,
    amh = amh_ng_m_l,
    prl = prl_ng_m_l,
    vitd3 = vit_d3_ng_m_l,
    prg = prg_ng_m_l,
    rbs = rbs_mg_dl,
    weight_gain = weight_gain_y_n,
    hair_growth = hair_growth_y_n,
    skin_darkening = skin_darkening_y_n,
    hair_loss = hair_loss_y_n,
    pimples = pimples_y_n,
    fast_food = fast_food_y_n,
    reg_exercise = reg_exercise_y_n,
    bp_systolic = bp_systolic_mm_hg,
    bp_diastolic = bp_diastolic_mm_hg,
    avg_f_size_l = avg_f_size_l_mm,
    avg_f_size_r = avg_f_size_r_mm,
    endometrium = endometrium_mm
    )

# Mutate variables incorrectly labelled as character to numeric and those 
# incorrectly labelled as numeric to factors
data = data %>% 
  mutate(id = as.character(id),
         pcos = as.factor(pcos),
         ii_betahcg = case_when(ii_betahcg == "1.99."~ "1.99", #I found
                                          #this typo when exploring the missing data and
                                          # checking the excel file of said individual
                                          TRUE ~ ii_betahcg),
         ii_betahcg = as.numeric(ii_betahcg),
         amh = as.numeric(amh),
         blood_group = as.factor (blood_group),
         pregnant = as.factor(pregnant),
         weight_gain = as.factor(weight_gain),
         hair_growth = as.factor(hair_growth),
         skin_darkening = as.factor(skin_darkening),
         hair_loss = as.factor(hair_loss),
         pimples = as.factor(pimples),
         fast_food = as.factor(fast_food),
         reg_exercise = as.factor(reg_exercise))

# The levels of binary variables are set to 'No' and 'Yes' to assist analysis later
levels(data$pcos)=c("No","Yes")
levels(data$pregnant)=c("No","Yes")
levels(data$weight_gain)=c("No","Yes")
levels(data$hair_growth)=c("No","Yes")
levels(data$skin_darkening)=c("No","Yes")
levels(data$hair_loss)=c("No","Yes")
levels(data$pimples)=c("No","Yes")
levels(data$fast_food)=c("No","Yes")
levels(data$reg_exercise)=c("No","Yes")
levels(data$blood_group)=c("A+","A-","B+","B-","O+","O-","AB+","AB-")

# Overview of the cleaned data
skim(data)
```
## 2.3 Missing values
The missing variables are checked using the plot below.

```{r plot missing data, fig.dim = c(8, 10)}
plot_missing(data)
```
One missing value is recorded for the variables fast_food, marriage_status and amh. The code below aims to determine whether the missing data points are all for the same person.

```{r}
data %>% 
  filter(is.na(fast_food) | 
           is.na(marriage_status) |
           is.na(amh)) %>% 
  dplyr::select(c(id, fast_food, marriage_status, amh)) %>% 
  knitr::kable()
```

We can observe that the individuals with missing observations are different, and thus these observations (rows) do not need to be removed at this stage. If missing variables end up in the training data set, these will be managed with multiple imputation.

## 2.4 Variation in continuous variables
The variability of continuous variables in the dataset are explored using the histograms below.
 
```{r}
plot_histogram(data)
```

### 2.4.1 Outliers
We can observe that the variables prg, vit_d3, fsh_lh, fsh, i_betahcg, ii_betahcg, lh and pulse_rate seem to have no variation. This could be happening because of the presence of outliers that make the data look like if it were invariant, or because of the data is not normally distributed in these variables. This can be checked by observing the summary of said variables. These are explored in detail.

```{r}
data %>%
  dplyr::select(prg, vitd3, fsh_lh_ratio, fsh, i_betahcg, ii_betahcg, lh, pulse_rate) %>% 
  rownames_to_column(var = "ID") %>% 
  pivot_longer(-ID, names_to = "variables", values_to = "data") %>% 
  group_by(variables) %>% 
  summarise(mean = mean(data, na.rm = TRUE),
            q1 = quantile(data, 0.25),
            median = quantile(data, 0.5),
            q3 = quantile(data,0.75),
            max = max(data), 
            min = min(data)) %>% 
  knitr::kable()
```

By looking at the median and quartiles, we can observe that the data looks not to be normally distributed because there are outliers that drag the distributions. I will check which samples are outliers for each of these variables. 

#### FSH hormone

Now, I will look for outliers in the FSH hormone
```{r}
## FSH hormone
data %>% 
  ggplot(aes(x = "fsh", y = fsh)) +
  geom_jitter(alpha = 0.5) +
  scale_y_log10()+
  xlab("")

data %>% 
  filter(fsh > 1000) %>% 
  pull(id)
```

According to [reference values](https://www.mountsinai.org/health-library/tests/follicle-stimulating-hormone-fsh-blood-test), this sample has an impossible biological value. Therefore, I will set this observation and related variables to NA. 

```{r}
data[data$id == 330,"fsh" ] = NA
data[data$id == 330,"fsh_lh" ] = NA
```

I will also log10 transform the values because looking at the quartiles above, data is compressed in the left side of the histogram

```{r, m}
data = data %>% 
  mutate(fsh = log10(fsh))

data %>% 
  ggplot(aes(x = "fsh", y = fsh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
  
```

#### LH hormone

Now, I will look for outliers in the LH hormone
```{r}
## LH hormone 
data %>% 
  ggplot(aes(x = "lh", y = lh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  filter(lh > 1000) %>% 
  pull(id)
```

The individual 456 has a LH level outside of the reported [reference levles](https://www.urmc.rochester.edu/encyclopedia/content.aspx?ContentTypeID=167&ContentID=luteinizing_hormone_blood). Therefore, I will remove this variable and related ones and also log10-transform it. It is worth noticing that this individual is different to the one that had an anomalous FSH level, which supports the hypothesis if these values being technical mistakes.

```{r}
data[data$id == 456,"lh" ] = NA
data[data$id == 456,"fsh_lh" ] = NA

data = data %>% 
  mutate(lh = log10(lh))

data %>% 
  ggplot(aes(x = "lh", y = lh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

#### FSH/LH ratio

Since I have already removed outliers from the FSH and LH variables, the remaining outlier here should be biologically occurrent. Then, I will only log10-transform this variable. 

```{r}
## FSH/LH ratio
data %>% 
  ggplot(aes(x = "fsh_lh", y = fsh_lh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  filter(fsh_lh > 250) %>% 
  pull(id)

#I will flag this patient in case it pops out somewhere else in the analysis. 

data = data %>% 
  mutate(fsh_lh = log10(fsh_lh))

data %>% 
  ggplot(aes(x = "fsh_lh", y = fsh_lh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

#### Human chorionic gonadotropin (hCG) in the blood

According to [reference levels](https://americanpregnancy.org/getting-pregnant/hcg-levels/), the values present in our dataset are within the expected biological range. Then, I will just log-10 transform these variables.
```{r}
data %>% 
  dplyr::select(c(id, i_betahcg, ii_betahcg, pregnant)) %>% 
  pivot_longer(- c(id,pregnant), names_to = "test", values_to = "data") %>% 
  ggplot(aes(x = test, y = data, color = pregnant)) +
  geom_jitter() 

data = data %>% 
  mutate(i_betahcg = log10(i_betahcg),
         ii_betahcg = log10(ii_betahcg))

#look at the data after transformation 
data %>% 
  dplyr::select(c(id, i_betahcg,ii_betahcg, pregnant)) %>% 
  pivot_longer(- c(id,pregnant), names_to = "test", values_to = "data") %>% 
  ggplot(aes(x = test, y = data)) +
  geom_jitter(alpha= 0.5) +
  geom_hline(yintercept = log10(5))+ 
  facet_grid("pregnant")
```

We can observe that even though both tests are supposed to measure the same hormone in blood, they do not provide similar results for many cases. Since the dataset does not provide more information about the tests, there is no way to know which one is more accurate, which would allow me to drop one of the variables. Also, it is weird that non-pregnant women are supposed to have a level of less than 5 mIU/mL. With the last plot, we can see that this is condition is not met; test 1 seems to have more false negatives, and test 2 seems to have more false positives. For now, I will keep both of these variables. 


#### Progesterone
According to [reference levels](https://www.urmc.rochester.edu/encyclopedia/content.aspx?ContentTypeID=167&ContentID=progesterone), the values in the dataset seem to be biologically possible. Then, I will only log-10 transform the data. 

```{r}
data %>% 
  ggplot(aes(x = "prg", y = prg, color = pregnant)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data = data %>% 
  mutate(prg = log10(prg)) 

data %>% 
  ggplot(aes(x = "prg", y = prg, color = pregnant)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

Progesterone levels are very variable depending on the mentstrual cycle stage of the person, so everything looks in order. Non-pregnant women might have a progesterone concentration of up to 25 ng/mL in the luteal stage of the menstrual cycle, which would explain the red dot in the upper part. 

#### Vitamin D3
It has been reported that a normal range of vitamin D is 30 to 74 ng/mL, and that [side effects or toxicity can occur when blood concentrations reach 88 ng/mL or greater](https://www.uspharmacist.com/article/vitamin-d-supplementation-an-update). Then, the outliers in the data are biologically not possible. 

```{r}
data %>% 
  ggplot(aes(x = "vitd3", y = vitd3)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

Therefore, I will remove those values.

```{r}
data %>% 
  filter(vitd3 > 90) %>% 
  pull(id)

data[data$vitd3>90,"vitd3"] = NA

#Plot the data again

data %>% 
  ggplot(aes(x = "vitd3", y = vitd3)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

#### Pulse rate
It is reported that the normal pulse rate goes from [60 to 100 bpm](https://www.bhf.org.uk/informationsupport/heart-matters-magazine/medical/ask-the-experts/pulse-rate). Then, I will remove the observations that fall outside of that range
```{r}
data %>% 
  ggplot(aes(x = "pulse_rate", y = pulse_rate)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  filter(pulse_rate < 60) %>% 
  pull(id)

data[data$pulse_rate < 60,"pulse_rate"] = NA

#Re plot the data
data %>% 
  ggplot(aes(x = "pulse_rate", y = pulse_rate)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```


#### Thyroid Stimulating Hormone (TSH)

Now, I will look for outliers in the TSH hormone

```{r}
data %>% 
  ggplot(aes(x = "tsh", y = tsh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

There seems to be an outlier as well, since TSH levels in women with PCOS is around [6.4 ±4.2 mIU/L](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7812530/). 

```{r}
data %>% 
  filter(tsh > 40) %>% 
  pull(id)
#I will flag this patient in case it pops out somewhere else in the analysis. 

data[data$tsh > 40,"tsh" ] = NA

#Transform the variable
data = data %>% 
  mutate(tsh = log10(tsh))

#Re plot the data
data %>% 
  ggplot(aes(x = "tsh", y = tsh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

#### Anti-Mullerian Hormone (AMH)
Now, I will look for outliers in the AMH hormone
```{r}
data %>% 
  ggplot(aes(x = "amh", y = amh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  filter(amh > 40) %>% 
  pull(id)
#I will flag this patient in case it pops out somewhere else in the analysis.
```

I will remove the observation with AMH levels > 60 ng/mL since the reported values for women with PCOS have been reported to be around 4.32 ng/mL (2.633–7.777) in [previous studies](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5895547/).There are other values that seem to be too high, but I will only remove the outlier that is clearly separated from the rest of the observations. 

```{r}
data[data$id == 268,"amh" ] = NA

#Transform the variable
data = data %>% 
  mutate(amh = log10(amh))

#Re plot the data
data %>% 
  ggplot(aes(x = "amh", y = amh)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

#### Blood presure
Now, I will look for outliers in the blood presure. 
```{r}
data %>% 
  ggplot(aes(x = "bp_systolic", y = bp_systolic)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  ggplot(aes(x = "bp_diastolic", y = bp_diastolic)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

We can observe that there are two different atypical patients with a very odd blood presure. Both of them have a diastolic or systolic blood presure of almost 0 mm/Hg, which is impossible for a living human being. Then, I will set both of them to NA.

```{r}
data %>% 
  filter(bp_diastolic < 50 |bp_systolic < 50) %>% 
  pull(id)
#I will flag this patient in case it pops out somewhere else in the analysis.
data[data$bp_diastolic < 15,"bp_diastolic" ] = NA
data[data$bp_systolic < 15,"bp_systolic" ] = NA

#Re plot the data
data %>% 
  ggplot(aes(x = "bp_systolic", y = bp_systolic)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

data %>% 
  ggplot(aes(x = "bp_diastolic", y = bp_diastolic)) +
  geom_jitter(alpha = 0.5) +
  xlab("")

```

#### Random blood sugar (glucose) test
Now, I will look for outliers in the random blood sugar (glucose) test.
```{r}
data %>% 
  ggplot(aes(x = "rbs", y = rbs)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

According to the [literature](https://www.mayoclinic.org/diseases-conditions/diabetic-coma/symptoms-causes/syc-20371475), glucose levels can go as up as the ones that are observed. This would likely imply the existence of a syndrome, as well as many physiological consequences. Since this value is then biologically possible, I will keep it. However, I will log-transform the variable. 

```{r}
#Transform the variable
data = data %>% 
  mutate(rbs = log10(rbs))

#Re plot the data
data %>% 
  ggplot(aes(x = "rbs", y = rbs)) +
  geom_jitter(alpha = 0.5) +
  xlab("")
```

#### Re plot the distribution of the variables 
Next, I will re plot the variables to see how the distribution of the variables changed. 
```{r}
plot_histogram(data)
```

## Explore variation of categorical variables
Now, I will explore the variability of the categorical variables.

```{r}
plot_bar(data %>% 
           dplyr::select(-id))
```
We can observe that none of the variables show an important lack of variation. Then, I won't remove any of them. 

## Explore covariation
Finally, I will explore the covariation of all of the variables in the dataset to see if there's any strong correlation between some of my variables that need to be accounted for. 

```{r,  fig.dim = c(8, 10)}
plot_correlation(data %>% 
                   dplyr::select(-id), 
                 type = 'all',
                 cor_args = list("use" = "complete.obs"))
```

At this stage, I can observe correlation of some variables that call my attention. I can see some degree of correlation between discrete variables, such as skin darkening, hair growth, weight gain and PCOS. Also, there is correlation between some continuous variables, such as waist and hip, FSH and LH, BMI and weight (which is expected), etc. I will keep this in mind in the future of the analysis, but I won't remove any variable at this point based on this criteria. I expect these correlations to be addressed in future steps of my project where I implement feature selection. 

## Save clean object

Finally, I will save the object for future stages of this project. 

```{r}
save(data,file =  here("data.Rdata"))
```


## Conclusion
This EDA was very helpful to familiarize myself with the data, clean it, and identify any pattern that could potentially need to be addressed in the future of my analysis. I was able to flag individuals with missing observations, remove outliers, transform some variables so that they had a higher variability range, and observe the correlation between my variables. 

## Session info
```{r}
sessionInfo()
```


